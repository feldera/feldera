# Dataflow JIT Todo list

- [ ] Cleanup dataflow generation code
  - [ ] ~~Implement dynamic scoping so that we can have arbitrarily nested scopes~~
  - [ ] Implement a fixed level of nesting (minimum of 3, 5 probably gives us some good leeway)
  - [ ] Dynamically generated timestamp types (e.g. dynamically generate timestamp impls for `[u32; 5]` for 5 levels of nesting)
- [ ] More codegen debug checks, make sure that none of our pointers ever go out of bounds of any of our objects
- [ ] Add debug layout checks to all dataflow operators
- [ ] Validation infrastructure
  - [ ] Type checking, make sure all accesses and operations are properly typed
  - [ ] Well-formedness checks
  - [ ] Initialization checks, make sure that all relevant columns are properly initialized
  - [ ] Ensure that all things that require cloning are indeed cloned
    - If a string comes from an `input` row, it must be cloned before being stored anywhere 
- [ ] Row vectors
  - Instead of `OrdZSet<Row, Weight>` we want a custom collection that holds untyped values, a truly untyped `DynVec`
  - Requires changes in a lot of the more fundamental `Trace`-related traits
  - A switch to an internally iterated api could address this
- [ ] Implement `rkyv::{Archive, Serialize, Deserialize}` for row values
- [ ] Better layout algorithm
  - [ ] Add switch to make all null flags standalone booleans (that is, instead of bitsets make them each take up one byte)
  - [ ] Allow null niching strings
  - [ ] Spread out null flags as much as possible so that we have as many single byte flags as possible (they're more efficient to operate over)
- [ ] Optimizations of both the inner functions and the dataflows themselves
  - [ ] Eliminate const filters
  - [ ] Fuse filters, maps and filter maps
  - [ ] Turn non-mutating filter maps into filters
  - [ ] Linear operators can probably be fused with neg as well
  - [ ] Dataflow propagation, we can optimize things based off of their input attributes (e.g. a stream that comes
        from a `filter (x > 10)` tells us that `x` will always be greater than ten)
  - [ ] Automatically generate owned versions of functions
    - Automatically evaluate whether or not the owned version is actually better than the borrowed one
  - [ ] Once native row collections are implemented we can operate over them directly within our functions instead of
        using callback functions. This should be a significant speedup for things like filter and map
  - [ ] Auto-vectorization of operations over native row collections
  - [ ] When operating over persistent collections we can lazily deserialize/decode values, potentially benefiting projections
  - [x] Automatically deduplicate loads from input rows
  - [ ] Allow functions to be modified after they're built so they can be optimized
  - [ ] Constant folding
- [x] Add date and timestamp generation to proptesting so we can fuzz the relevant code
- [ ] Deduplicate functions, could help in reducing the number of functions we optimize and compile and could
      even allow us to deduplicate nodes with previously different inner functions
- [ ] Configurable difference/weight type, currently hardcoded to `i32`
- [ ] Dataflow planning optimizations
  - [ ] Push/pull differentiation and integration
  - [ ] Automatic incrementalization
  - [ ] Push/pull exchanges
  - [ ] Push/pull gathers
- [ ] Basic block parameters
  - [ ] Promote branched allocas to basic block args (or to `select`)
- [ ] Textual debugging for graphs
- [ ] Textual debugging for ir
- [ ] Add the ability to drop values (mainly strings) within ir
- [ ] Add a borrowed/static version of strings (maybe `&str` style `{ ptr, len }`)
- [ ] Arrays
- [ ] Inline small row values into the `Row` pointer
- [ ] C FFI
- [ ] Operators
  - [x] Flat Map
  - [x] Fold
  - [ ] Linear aggregations
  - [x] Max aggregate
  - [ ] Windows
- [ ] Intrinsic functions
  - [ ] Proc macro for registering intrinsics
  - [ ] `@dbsp.min()`
  - [ ] `@dbsp.max()`
  - [x] `@dbsp.error.abort()`
  - [x] `@dbsp.row.vec.push()`
  - [ ] `@dbsp.row.vec.reserve()`
  - [ ] String manipulation
    - [x] `@dbsp.str.truncate()`
    - [x] `@dbsp.str.truncate_clone()`
    - [x] `@dbsp.str.clear()`
    - [x] `@dbsp.str.concat()` (Can now concat an unbounded number of strings)
    - [x] `@dbsp.str.concat_clone()` (Can now concat an unbounded number of strings)
    - [ ] `@dbsp.str.is_normalized()` (check for NFC, NFD, NFKC or NFKD normalization)
      - [x] `@dbsp.str.is_nfc()`
      - [x] `@dbsp.str.is_nfd()`
      - [x] `@dbsp.str.is_nfkc()`
      - [x] `@dbsp.str.is_nfkd()`
    - [ ] `@dbsp.str.to_normalized()` (NFC, NFD, NFKC or NFKD normalization)
    - [ ] `@dbsp.str.make_normalized()` (NFC, NFD, NFKC or NFKD normalization)
    - [x] `@dbsp.str.bit_length()`
    - [x] `@dbsp.str.char_length()`
    - [x] `@dbsp.str.byte_length()`
    - [x] `@dbsp.str.is_lowercase()`
    - [ ] `@dbsp.str.to_lowercase()`
    - [ ] `@dbsp.str.make_lowercase()`
    - [x] `@dbsp.str.is_uppercase()`
    - [ ] `@dbsp.str.to_uppercase()`
    - [ ] `@dbsp.str.make_uppercase()`
    - [x] `@dbsp.str.is_ascii()`
    - [x] `@dbsp.str.write()`
    - [x] `@dbsp.str.with.capacity()`
  - [ ] Vec/Array manipulation
  - [ ] Timestamp manipulation
    - [x] `@dbsp.timestamp.epoch`
    - [x] `@dbsp.timestamp.year`
    - [x] `@dbsp.timestamp.month`
    - [x] `@dbsp.timestamp.day`
    - [x] `@dbsp.timestamp.quarter`
    - [x] `@dbsp.timestamp.decade`
    - [x] `@dbsp.timestamp.century`
    - [x] `@dbsp.timestamp.millennium`
    - [x] `@dbsp.timestamp.iso_year`
    - [x] `@dbsp.timestamp.week`
    - [x] `@dbsp.timestamp.day_of_week`
    - [x] `@dbsp.timestamp.iso_day_of_week`
    - [x] `@dbsp.timestamp.day_of_year`
    - [x] `@dbsp.timestamp.millisecond`
    - [x] `@dbsp.timestamp.microsecond`
    - [x] `@dbsp.timestamp.second`
    - [x] `@dbsp.timestamp.minute`
    - [x] `@dbsp.timestamp.hour`
    - [x] `@dbsp.timestamp.floor_week`
    - [x] `@dbsp.timestamp.to_date`
  - [ ] Date manipulation
    - [x] `@dbsp.date.year`
    - [x] `@dbsp.date.month`
    - [x] `@dbsp.date.day`
    - [x] `@dbsp.date.quarter`
    - [x] `@dbsp.date.decade`
    - [x] `@dbsp.date.century`
    - [x] `@dbsp.date.millennium`
    - [x] `@dbsp.date.iso_year`
    - [x] `@dbsp.date.week`
    - [x] `@dbsp.date.day_of_week`
    - [x] `@dbsp.date.iso_day_of_week`
    - [x] `@dbsp.date.day_of_year`
    - [x] `@dbsp.date.epoch`
    - [x] `@dbsp.date.hour` (returns constant zero)
    - [x] `@dbsp.date.second` (returns constant zero)
    - [x] `@dbsp.date.minute` (returns constant zero)
    - [x] `@dbsp.date.millisecond` (returns constant zero)
    - [x] `@dbsp.date.microsecond` (returns constant zero)
    - [x] `@dbsp.date.to_timestamp`
  - [ ] Math functions (taken from <https://www.postgresql.org/docs/current/functions-math.html>)
    - [ ] Degrees to radians
    - [ ] Radians to degrees
    - [ ] Factorial
    - [ ] Greatest common divisor
    - [ ] Least common multiple
    - [ ] Logarithm `x` to base `b`
    - [ ] Power
    - [ ] `@dbsp.math.sign({int, float}) -> {int, float}`
    - [x] `@dbsp.math.is_sign_positive({int, float}) -> bool`
    - [x] `@dbsp.math.is_sign_negative({int, float}) -> bool`
    - [x] `@dbsp.math.cos()`
    - [ ] `@dbsp.math.cosd()`
    - [x] `@dbsp.math.acos()`
    - [ ] `@dbsp.math.acosd()`
    - [x] `@dbsp.math.cosh()`
    - [x] `@dbsp.math.acosh()`
    - [x] `@dbsp.math.sin()`
    - [ ] `@dbsp.math.sind()`
    - [x] `@dbsp.math.asin()`
    - [ ] `@dbsp.math.asind()`
    - [x] `@dbsp.math.tan()`
    - [ ] `@dbsp.math.tand()`
    - [x] `@dbsp.math.atan()`
    - [ ] `@dbsp.math.atand()`
    - [ ] `@dbsp.math.atan2()`
    - [ ] `@dbsp.math.atan2d()`
    - [x] `@dbsp.math.cot()`
    - [ ] `@dbsp.math.cotd()`
    - [x] `@dbsp.math.sinh()`
    - [x] `@dbsp.math.cosh()`
    - [x] `@dbsp.math.tanh()`
    - [x] `@dbsp.math.asinh()`
    - [x] `@dbsp.math.atanh()`
    - [x] `@dbsp.math.is_power_of_two()` Returns true if the given unsigned integer is a power of two
    - [x] `@dbsp.math.log()`
    - [x] `@dbsp.math.log2()`
    - [x] `@dbsp.math.log10()`
    - [x] `@dbsp.math.log1p()`
    - [x] `@dbsp.math.sqrt()` Square root
    - [x] `@dbsp.math.cbrt()` Cube root
    - [x] `@dbsp.math.tgamma()`
    - [x] `@dbsp.math.lgamma()`
    - [x] `@dbsp.math.exp()`
    - [x] `@dbsp.math.exp2()`
    - [x] `@dbsp.math.exp10()`
    - [x] `@dbsp.math.expm1()`
    - [x] `@dbsp.math.fdim()` Positive difference between floating point values
    - [x] `@dbsp.math.radians_to_degrees()` Converts radians to degrees
    - [x] `@dbsp.math.degrees_to_radians()` Converts degrees to radians
    - [x] `@dbsp.sql.round(f32, i32)`/`@dbsp.sql.round(f64, i32)`
  - [ ] `@dbsp.str.format()`
  - [x] `@dbsp.io.str.print()`
