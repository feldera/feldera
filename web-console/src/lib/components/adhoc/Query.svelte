<script lang="ts" module>
  import { useSkeletonTheme } from '$lib/compositions/useSkeletonTheme.svelte'
  import type { SQLValueJS } from '$lib/functions/sqlValue'
  import type { Field } from '$lib/services/manager'
  import { Progress } from '@skeletonlabs/skeleton-svelte'

  export type Row = { cells: SQLValueJS[] } | { error: string } | { warning: string }

  export type QueryResult = {
    rows: Row[]
    columns: Field[]
    totalSkippedBytes: number
    endResultStream: () => void
  }

  export type QueryData = {
    query: string
    progress?: boolean
    result?: QueryResult
  }

  const handleKeyDown =
    (onSubmitQuery: (query: string) => void, disabled: boolean) => (e: KeyboardEvent) => {
      // Enter to submit, Shift + Enter to enter newline
      if (e.key === 'Enter') {
        if (e.shiftKey || e.altKey || e.ctrlKey) {
          return
        }
        if (!disabled) {
          onSubmitQuery((e as any).currentTarget.value)
        }
        e.preventDefault()
        return
      }
    }
</script>

<script lang="ts">
  import SQLValue from '$lib/components/relationData/SQLValue.svelte'
  import SqlColumnHeader from '$lib/components/relationData/SQLColumnHeader.svelte'
  import { usePopoverTooltip } from '$lib/compositions/common/usePopoverTooltip.svelte'
  import ReverseScrollFixedList from '$lib/components/pipelines/editor/ReverseScrollFixedList.svelte'

  let {
    query = $bindable(),
    result,
    progress,
    onSubmitQuery,
    onDeleteQuery,
    onCancelQuery,
    disabled,
    isLastQuery
  }: {
    onSubmitQuery: (query: string) => void
    onDeleteQuery: () => void
    onCancelQuery?: () => void
    disabled: boolean
    isLastQuery: boolean
  } & QueryData = $props()

  const theme = useSkeletonTheme()

  // Handle hover popup over table cells to display full SQL value
  let popupRef: HTMLElement | undefined = $state()
  let tooltip = usePopoverTooltip(() => popupRef)
  const keepMaxWidth = (element: HTMLElement) => {
    const observer = new ResizeObserver(([entry]) => {
      maxW = Math.max(maxW, entry.borderBoxSize[0].inlineSize)
      element.style.width = `${maxW}px`
    })
    observer.observe(element)
    let maxW = $state(0)
    return {
      destroy() {
        observer.disconnect()
      }
    }
  }
</script>

<div
  class="bg-white-dark absolute m-0 w-max max-w-lg -translate-x-[4.5px] -translate-y-[2.5px] whitespace-break-spaces break-words border border-surface-500 px-2 py-1 text-surface-950-50"
  popover="manual"
  bind:this={popupRef}
  style={tooltip.data
    ? `left: ${tooltip.data.x}px; top: ${tooltip.data.y}px; min-width: ${tooltip.data.targetWidth + 8}px`
    : ''}
>
  {tooltip.data?.text}
</div>

<div
  class="flex flex-nowrap items-start"
  role="presentation"
  onkeydown={(e) => {
    if (e.code === 'KeyC' && (e.ctrlKey || e.metaKey)) {
      onCancelQuery?.()
    }
  }}
>
  <div class="w-full">
    <div class="flex max-w-[1000px] flex-col rounded border p-2 border-surface-100-900">
      <div class="flex w-full flex-col gap-2">
        <textarea
          bind:value={query}
          style="font-family: {theme.config.monospaceFontFamily}; field-sizing: content"
          class="bg-white-dark w-full overflow-auto rounded border-0 !ring-0 !ring-primary-500 text-surface-950-50 scrollbar"
          placeholder="SELECT * FROM ..."
          onkeydown={handleKeyDown(onSubmitQuery, disabled)}
        ></textarea>
        <div class="flex flex-nowrap items-center">
          <div class="flex h-10 flex-none">
            {#if progress}
              <button
                class="fd fd-square w-10 p-2 text-[20px]"
                onclick={onCancelQuery}
                aria-label="Stop query"
              ></button>
            {:else}
              <button
                {disabled}
                class="fd fd-play w-10 p-2 text-[20px]"
                onclick={() => onSubmitQuery(query)}
                aria-label="Run query"
              ></button>
            {/if}
            {#if !isLastQuery}
              <button
                class="fd fd-trash-2 w-10 p-2 text-[20px]"
                onclick={onDeleteQuery}
                aria-label="Delete query"
              ></button>
            {:else}
              <div class="w-10"></div>
            {/if}
          </div>
          <div class="flex h-6 w-full flex-nowrap items-center gap-4 whitespace-nowrap">
            {#if result}
              {result.rows.length > 1
                ? `${result.rows.length} rows`
                : result.rows.length === 0
                  ? 'No rows returned'
                  : ''}
            {/if}
            {#if progress}
              <Progress value={null} meterBg="bg-primary-500" base="h-1 max-w-[1000px]"></Progress>
            {/if}
          </div>
        </div>
      </div>
    </div>

    {#if result}
      {#key result.columns}
        <div class="pr-4 pt-2">
          <div class="relative h-full w-fit max-w-full">
            <ReverseScrollFixedList
              itemSize={28}
              items={result.rows}
              class=""
              stickyIndices={[]}
              marginTop={28}
            >
              {#snippet listContainer(items, { height, onscroll, onresize, setref })}
                {@const _height = {
                  set current(x: number) {
                    onresize({ clientHeight: x })
                  }
                }}
                {@const ref = {
                  set current(el: HTMLElement) {
                    setref(el)
                  }
                }}
                <div
                  class="relative h-full max-h-64 w-fit max-w-full overflow-auto rounded scrollbar"
                  {onscroll}
                  bind:clientHeight={_height.current}
                  bind:this={ref.current}
                >
                  <table style:height class="w-fit" use:keepMaxWidth>
                    {#if result.columns.length}
                      <thead>
                        <tr>
                          {#each result.columns as column}
                            <SqlColumnHeader {column} class="bg-white-dark sticky top-0 z-10 h-7"
                            ></SqlColumnHeader>
                          {/each}
                        </tr>
                      </thead>
                    {/if}
                    <tbody>
                      {@render items()}
                    </tbody>
                  </table>
                </div>
              {/snippet}
              {#snippet item(row, style, padding, isSticky)}
                {#if 'cells' in row}
                  <tr {style} class="h-7 whitespace-nowrap odd:bg-white odd:even:bg-black">
                    {#each row.cells as value}
                      <SQLValue
                        {value}
                        class="cursor-pointer"
                        props={(format) => ({
                          onclick: tooltip.showTooltip(format(value)),
                          onmouseleave: tooltip.onmouseleave
                        })}
                      ></SQLValue>
                    {/each}
                  </tr>
                {:else if 'error' in row}
                  <tr {style} class="h-7">
                    <td colspan="99999999" class="px-2 preset-tonal-error">{row.error}</td>
                  </tr>
                {:else}
                  <tr {style} class="h-7">
                    <td colspan="99999999" class="px-2 preset-tonal-warning">{row.warning}</td>
                  </tr>
                {/if}
              {/snippet}
              {#snippet footer()}
                <tr style="height: auto; ">
                  <td></td>
                </tr>
              {/snippet}
            </ReverseScrollFixedList>
          </div>
        </div>
      {/key}
    {/if}
  </div>
</div>
